name: CI Repair Bot

  on:
    workflow_run:
      workflows: ["Nightly Full Suite"]
      types: [completed]

  concurrency:
    group: ci-repair
    cancel-in-progress: false

  jobs:
    repair:
      name: Attempt Automated Repair
      runs-on: ubuntu-latest
      if: >
        github.event.workflow_run.conclusion == 'failure' &&
        github.event.workflow_run.head_branch == 'main'

      permissions:
        actions: read
        contents: write
        pull-requests: write
        issues: write

      steps:
        - name: Checkout repository at failing commit
          uses: actions/checkout@v4
          with:
            ref: ${{ github.event.workflow_run.head_sha }}
            fetch-depth: 0

        - name: Setup Node.js
          uses: actions/setup-node@v4
          with:
            node-version: '20'
            cache: 'npm'

        - name: Create context directory
          run: mkdir -p .ci_context/artifacts

        - name: Collect run metadata
          env:
            GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
            RUN_ID: ${{ github.event.workflow_run.id }}
          run: |
            echo "Collecting metadata for run $RUN_ID..."
            gh api repos/${{ github.repository }}/actions/runs/$RUN_ID > .ci_context/run.json
            gh api repos/${{ github.repository }}/actions/runs/$RUN_ID/jobs > .ci_context/jobs.json
            gh run view $RUN_ID --log-failed > .ci_context/failed.log 2>&1 || true
            echo "Context collected successfully"

        - name: Download artifacts from failing run
          env:
            GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
            RUN_ID: ${{ github.event.workflow_run.id }}
          run: |
            ARTIFACTS=$(gh api repos/${{ github.repository }}/actions/runs/$RUN_ID/artifacts --jq '.artifacts[].name' 2>/dev/null || echo "")
            if [ -n "$ARTIFACTS" ]; then
              for name in $ARTIFACTS; do
                gh run download $RUN_ID -n "$name" -D ".ci_context/artifacts/$name" 2>/dev/null || true
              done
            fi

        - name: Install dependencies
          run: npm ci

        - name: Run CI Repair Script
          id: repair
          env:
            ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
            RUN_ID: ${{ github.event.workflow_run.id }}
            RUN_URL: ${{ github.event.workflow_run.html_url }}
          run: node scripts/ci-repair.mjs
          continue-on-error: true

        - name: Install Playwright browsers
          if: steps.repair.outputs.patch_applied == 'true'
          run: npx playwright install --with-deps chromium

        - name: Verify - TypeScript
          id: verify-typecheck
          if: steps.repair.outputs.patch_applied == 'true'
          run: npm run typecheck
          continue-on-error: true

        - name: Verify - Lint
          id: verify-lint
          if: steps.repair.outputs.patch_applied == 'true' && steps.verify-typecheck.outcome == 'success'
          run: npm run lint
          continue-on-error: true

        - name: Verify - Unit tests
          id: verify-unit
          if: steps.repair.outputs.patch_applied == 'true' && steps.verify-lint.outcome == 'success'
          run: npm run test:unit
          continue-on-error: true

        - name: Build
          id: build
          if: steps.repair.outputs.patch_applied == 'true' && steps.verify-unit.outcome == 'success'
          run: npm run build
          continue-on-error: true

        - name: Verify - E2E smoke tests
          id: verify-e2e
          if: steps.build.outcome == 'success'
          run: npx playwright test --project=smoke
          continue-on-error: true

        - name: Determine result
          id: verify-result
          run: |
            if [ "${{ steps.repair.outputs.patch_applied }}" != "true" ]; then
              echo "result=no_patch" >> $GITHUB_OUTPUT
            elif [ "${{ steps.verify-typecheck.outcome }}" != "success" ]; then
              echo "result=typecheck_failed" >> $GITHUB_OUTPUT
            elif [ "${{ steps.verify-lint.outcome }}" != "success" ]; then
              echo "result=lint_failed" >> $GITHUB_OUTPUT
            elif [ "${{ steps.verify-unit.outcome }}" != "success" ]; then
              echo "result=unit_failed" >> $GITHUB_OUTPUT
            elif [ "${{ steps.build.outcome }}" != "success" ]; then
              echo "result=build_failed" >> $GITHUB_OUTPUT
            elif [ "${{ steps.verify-e2e.outcome }}" != "success" ]; then
              echo "result=e2e_failed" >> $GITHUB_OUTPUT
            else
              echo "result=success" >> $GITHUB_OUTPUT
            fi

        - name: Create PR
          if: steps.verify-result.outputs.result == 'success'
          env:
            GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
            RUN_ID: ${{ github.event.workflow_run.id }}
            RUN_URL: ${{ github.event.workflow_run.html_url }}
          run: |
            BRANCH="ci/repair-${RUN_ID}"
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git checkout -b "$BRANCH"
            git add -A
            git commit -m "CI repair: fix failing tests (run ${RUN_ID})"
            git push origin "$BRANCH"
            gh pr create --title "CI Repair: Fix failing tests (#${RUN_ID})" --body "Automated fix for [run #${RUN_ID}](${RUN_URL}). Please review." --base main --head "$BRANCH"

        - name: Create Issue on failure
          if: steps.verify-result.outputs.result != 'success' && steps.verify-result.outputs.result != ''
          env:
            GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
            RUN_ID: ${{ github.event.workflow_run.id }}
            RUN_URL: ${{ github.event.workflow_run.html_url }}
            RESULT: ${{ steps.verify-result.outputs.result }}
          run: |
            gh issue create --title "CI Repair failed for run #${RUN_ID}" --body "Failed: ${RESULT}. See [run](${RUN_URL})." --label "ci-repair-failed" || true

        - name: Upload context
          if: always()
          uses: actions/upload-artifact@v4
          with:
            name: ci-repair-context-${{ github.event.workflow_run.id }}
            path: .ci_context/
            retention-days: 7
