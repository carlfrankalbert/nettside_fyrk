name: CI Repair Bot

  on:
    workflow_run:
      workflows: ["Nightly Full Suite"]
      types: [completed]

  # Only run one repair at a time
  concurrency:
    group: ci-repair
    cancel-in-progress: false

  jobs:
    repair:
      name: Attempt Automated Repair
      runs-on: ubuntu-latest
      # Only trigger on failure AND only for main branch
      if: >
        github.event.workflow_run.conclusion == 'failure' &&
        github.event.workflow_run.head_branch == 'main'

      permissions:
        actions: read
        contents: write
        pull-requests: write
        issues: write

      steps:
        - name: Checkout repository at failing commit
          uses: actions/checkout@v4
          with:
            ref: ${{ github.event.workflow_run.head_sha }}
            fetch-depth: 0

        - name: Setup Node.js
          uses: actions/setup-node@v4
          with:
            node-version: '20'
            cache: 'npm'

        - name: Create context directory
          run: mkdir -p .ci_context/artifacts

        - name: Collect run metadata
          env:
            GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
            RUN_ID: ${{ github.event.workflow_run.id }}
          run: |
            echo "Collecting metadata for run $RUN_ID..."

            # Save run metadata
            gh api repos/${{ github.repository }}/actions/runs/$RUN_ID > .ci_context/run.json

            # Save jobs metadata
            gh api repos/${{ github.repository }}/actions/runs/$RUN_ID/jobs > .ci_context/jobs.json

            # Extract and save failed logs
            gh run view $RUN_ID --log-failed > .ci_context/failed.log 2>&1 || true

            echo "Context collected successfully"

        - name: Download artifacts from failing run
          env:
            GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
            RUN_ID: ${{ github.event.workflow_run.id }}
          run: |
            echo "Attempting to download artifacts from run $RUN_ID..."

            # List artifacts
            ARTIFACTS=$(gh api repos/${{ github.repository }}/actions/runs/$RUN_ID/artifacts --jq '.artifacts[].name' 2>/dev/null || echo "")

            if [ -n "$ARTIFACTS" ]; then
              for name in $ARTIFACTS; do
                echo "Downloading artifact: $name"
                gh run download $RUN_ID -n "$name" -D ".ci_context/artifacts/$name" 2>/dev/null || true
              done
            else
              echo "No artifacts found"
            fi

        - name: Install dependencies
          run: npm ci

        - name: Run CI Repair Script
          id: repair
          env:
            ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
            RUN_ID: ${{ github.event.workflow_run.id }}
            RUN_URL: ${{ github.event.workflow_run.html_url }}
            REPO: ${{ github.repository }}
          run: node scripts/ci-repair.mjs
          continue-on-error: true

        - name: Install Playwright browsers (for verification)
          if: steps.repair.outputs.patch_applied == 'true'
          run: npx playwright install --with-deps chromium

        - name: Verify fix - TypeScript check
          id: verify-typecheck
          if: steps.repair.outputs.patch_applied == 'true'
          run: npm run typecheck
          continue-on-error: true

        - name: Verify fix - Lint
          id: verify-lint
          if: steps.repair.outputs.patch_applied == 'true' && steps.verify-typecheck.outcome == 'success'
          run: npm run lint
          continue-on-error: true

        - name: Verify fix - Unit tests
          id: verify-unit
          if: steps.repair.outputs.patch_applied == 'true' && steps.verify-lint.outcome == 'success'
          run: npm run test:unit
          continue-on-error: true

        - name: Build site for E2E tests
          id: build
          if: steps.repair.outputs.patch_applied == 'true' && steps.verify-unit.outcome == 'success'
          run: npm run build
          continue-on-error: true

        - name: Verify fix - E2E smoke tests
          id: verify-e2e
          if: steps.build.outcome == 'success'
          run: npx playwright test --project=smoke
          continue-on-error: true

        - name: Determine verification result
          id: verify-result
          run: |
            if [ "${{ steps.repair.outputs.patch_applied }}" != "true" ]; then
              echo "result=no_patch" >> $GITHUB_OUTPUT
            elif [ "${{ steps.verify-typecheck.outcome }}" != "success" ]; then
              echo "result=typecheck_failed" >> $GITHUB_OUTPUT
            elif [ "${{ steps.verify-lint.outcome }}" != "success" ]; then
              echo "result=lint_failed" >> $GITHUB_OUTPUT
            elif [ "${{ steps.verify-unit.outcome }}" != "success" ]; then
              echo "result=unit_failed" >> $GITHUB_OUTPUT
            elif [ "${{ steps.build.outcome }}" != "success" ]; then
              echo "result=build_failed" >> $GITHUB_OUTPUT
            elif [ "${{ steps.verify-e2e.outcome }}" != "success" ]; then
              echo "result=e2e_failed" >> $GITHUB_OUTPUT
            else
              echo "result=success" >> $GITHUB_OUTPUT
            fi

        - name: Create repair branch and PR
          if: steps.verify-result.outputs.result == 'success'
          env:
            GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
            RUN_ID: ${{ github.event.workflow_run.id }}
            RUN_URL: ${{ github.event.workflow_run.html_url }}
          run: |
            BRANCH_NAME="ci/repair-${RUN_ID}"

            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"

            git checkout -b "$BRANCH_NAME"
            git add -A
            git commit -m "CI repair: fix failing tests (run ${RUN_ID})"
            git push origin "$BRANCH_NAME"

            # Create PR
            gh pr create \
              --title "CI Repair: Fix failing tests (run #${RUN_ID})" \
              --body "$(cat <<EOF
            ## Automated CI Repair

            This PR was automatically generated by the CI Repair Bot to fix failing tests.

            ### Failing Run
            - **Run ID:** ${RUN_ID}
            - **Run URL:** ${RUN_URL}

            ### Verification Steps Passed
            - TypeScript check
            - ESLint
            - Unit tests (Vitest)
            - Build
            - E2E smoke tests (Playwright)

            ### Review Required
            This is an automated fix. Please review the changes carefully before merging.

            <details>
            <summary>Generated patch</summary>

            \`\`\`diff
            $(cat .ci_context/patch.diff 2>/dev/null || echo "Patch file not found")
            \`\`\`
            </details>

            ---
            *Generated by [CI Repair Bot](../blob/main/docs/ci-repair-bot.md)*
            EOF
            )" \
              --base main \
              --head "$BRANCH_NAME"

        - name: Create failure issue
          if: steps.verify-result.outputs.result != 'success' && steps.verify-result.outputs.result != ''
          env:
            GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
            RUN_ID: ${{ github.event.workflow_run.id }}
            RUN_URL: ${{ github.event.workflow_run.html_url }}
            RESULT: ${{ steps.verify-result.outputs.result }}
          run: |
            # Prepare log excerpt (last 100 lines, max 3000 chars)
            LOG_EXCERPT=""
            if [ -f .ci_context/failed.log ]; then
              LOG_EXCERPT=$(tail -100 .ci_context/failed.log | head -c 3000)
            fi

            # Map result to human-readable message
            case "$RESULT" in
              no_patch)
                FAILURE_REASON="Could not generate a valid patch"
                ;;
              typecheck_failed)
                FAILURE_REASON="TypeScript check failed after applying patch"
                ;;
              lint_failed)
                FAILURE_REASON="ESLint check failed after applying patch"
                ;;
              unit_failed)
                FAILURE_REASON="Unit tests failed after applying patch"
                ;;
              build_failed)
                FAILURE_REASON="Build failed after applying patch"
                ;;
              e2e_failed)
                FAILURE_REASON="E2E tests failed after applying patch"
                ;;
              *)
                FAILURE_REASON="Unknown failure"
                ;;
            esac

            gh issue create \
              --title "CI Repair failed for run #${RUN_ID}" \
              --body "$(cat <<EOF
            ## CI Repair Bot Failed

            The automated CI Repair Bot was unable to fix the failing tests.

            ### Details
            - **Failing Run ID:** ${RUN_ID}
            - **Failing Run URL:** ${RUN_URL}
            - **Failure Reason:** ${FAILURE_REASON}

            ### Failed Log Excerpt
            \`\`\`
            ${LOG_EXCERPT}
            \`\`\`

            ### Next Steps
            1. Review the [failing workflow run](${RUN_URL})
            2. Check the CI Repair workflow artifacts for full context
            3. Fix the issue manually

            ---
            *Generated by [CI Repair Bot](../blob/main/docs/ci-repair-bot.md)*
            EOF
            )" \
              --label "ci-repair-failed"

        - name: Upload context as artifact
          if: always()
          uses: actions/upload-artifact@v4
          with:
            name: ci-repair-context-${{ github.event.workflow_run.id }}
            path: .ci_context/
            retention-days: 7
