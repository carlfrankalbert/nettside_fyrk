---
export const prerender = false;

import {
  BETA_COOKIE_NAME,
  BETA_COOKIE_MAX_AGE,
  hasBetaAccess,
} from '../utils/feature-toggles';

// Get the secret token from environment
const cloudflareEnv = Astro.locals.runtime?.env;
const expectedToken = cloudflareEnv?.BETA_TOKEN;

// Check token from URL
const url = new URL(Astro.request.url);
const providedToken = url.searchParams.get('token');

// Check if user wants to deactivate
const deactivate = url.searchParams.get('deactivate') === 'true';

// Validate token
const validToken = expectedToken && providedToken === expectedToken;

// Check current beta status
const currentlyHasBeta = hasBetaAccess(Astro.cookies);

// Handle activation/deactivation
let activated = false;
let deactivated = false;

if (deactivate && currentlyHasBeta) {
  // Remove beta cookie
  Astro.cookies.delete(BETA_COOKIE_NAME, { path: '/' });
  deactivated = true;
} else if (validToken && !currentlyHasBeta) {
  // Set beta cookie
  Astro.cookies.set(BETA_COOKIE_NAME, 'true', {
    path: '/',
    maxAge: BETA_COOKIE_MAX_AGE,
    httpOnly: true,
    secure: true,
    sameSite: 'lax',
  });
  activated = true;
} else if (validToken && currentlyHasBeta) {
  // Already has beta access
  activated = false;
}

const showSuccess = activated || (validToken && currentlyHasBeta);
const showDeactivated = deactivated;
const showError = !validToken && !deactivate && !currentlyHasBeta;
---

<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex, nofollow">
  <title>Beta - FYRK</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: system-ui, -apple-system, sans-serif;
      background: #f5f5f5;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .card {
      background: white;
      border-radius: 16px;
      padding: 40px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      max-width: 400px;
      text-align: center;
    }
    .icon {
      font-size: 3rem;
      margin-bottom: 16px;
    }
    h1 {
      color: #1e3a5f;
      margin-bottom: 12px;
      font-size: 1.5rem;
    }
    p {
      color: #6b7280;
      margin-bottom: 24px;
      line-height: 1.6;
    }
    .success-card {
      border: 2px solid #22c55e;
    }
    .success-card h1 {
      color: #22c55e;
    }
    .error-card {
      border: 2px solid #ef4444;
    }
    .error-card h1 {
      color: #ef4444;
    }
    .deactivated-card {
      border: 2px solid #6b7280;
    }
    .btn {
      display: inline-block;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 0.95rem;
      text-decoration: none;
      transition: all 0.2s;
    }
    .btn-primary {
      background: #1e3a5f;
      color: white;
    }
    .btn-primary:hover {
      background: #2d5a87;
    }
    .btn-secondary {
      background: #f3f4f6;
      color: #374151;
      margin-left: 8px;
    }
    .btn-secondary:hover {
      background: #e5e7eb;
    }
    .buttons {
      display: flex;
      justify-content: center;
      gap: 12px;
      flex-wrap: wrap;
    }
    .note {
      font-size: 0.8rem;
      color: #9ca3af;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  {showSuccess && (
    <div class="card success-card">
      <div class="icon">&#x2713;</div>
      <h1>Beta aktivert!</h1>
      <p>
        Du har nå tilgang til beta-funksjoner på FYRK.
        {activated ? 'Tilgangen varer i 30 dager.' : 'Du hadde allerede tilgang.'}
      </p>
      <div class="buttons">
        <a href="/" class="btn btn-primary">Gå til forsiden</a>
      </div>
      <p class="note">
        Vil du deaktivere beta? <a href={`/beta?token=${providedToken}&deactivate=true`}>Klikk her</a>
      </p>
    </div>
  )}

  {showDeactivated && (
    <div class="card deactivated-card">
      <div class="icon">&#x2717;</div>
      <h1>Beta deaktivert</h1>
      <p>
        Beta-tilgang er nå deaktivert. Du ser nå kun vanlige funksjoner.
      </p>
      <div class="buttons">
        <a href="/" class="btn btn-primary">Gå til forsiden</a>
      </div>
    </div>
  )}

  {showError && (
    <div class="card error-card">
      <div class="icon">&#x26A0;</div>
      <h1>Ugyldig lenke</h1>
      <p>
        Denne beta-lenken er ugyldig eller utløpt. Kontakt oss for å få en ny lenke.
      </p>
      <div class="buttons">
        <a href="/" class="btn btn-primary">Gå til forsiden</a>
      </div>
    </div>
  )}
</body>
</html>
