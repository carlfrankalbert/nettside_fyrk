---
export const prerender = false;

import {
  getFeatureToggles,
  type FeatureToggle,
  type FeatureStatus,
  BETA_COOKIE_NAME,
} from '../utils/feature-toggles';

// Get the secret token from environment
const cloudflareEnv = Astro.locals.runtime?.env;
const expectedToken = cloudflareEnv?.FEATURE_TOGGLE_TOKEN;
const betaToken = cloudflareEnv?.BETA_TOKEN;

// Check token from URL
const url = new URL(Astro.request.url);
const providedToken = url.searchParams.get('token');

// Validate access
const hasAccess = expectedToken && providedToken === expectedToken;

// Get feature toggles if authorized
let features: FeatureToggle[] = [];
let updatedAt = '';

if (hasAccess) {
  const kv = cloudflareEnv?.ANALYTICS_KV;
  if (kv) {
    const togglesData = await getFeatureToggles(kv);
    features = togglesData.features;
    updatedAt = togglesData.updatedAt;
  }
}

// Generate beta activation URL
const betaActivationUrl = betaToken ? `/beta?token=${betaToken}` : null;

// Status labels and colors
const statusConfig: Record<FeatureStatus, { label: string; color: string; bg: string }> = {
  off: { label: 'Av', color: '#ef4444', bg: '#fef2f2' },
  beta: { label: 'Beta', color: '#f59e0b', bg: '#fffbeb' },
  on: { label: 'På', color: '#22c55e', bg: '#f0fdf4' },
};
---

<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex, nofollow">
  <title>Feature Toggles - FYRK</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: system-ui, -apple-system, sans-serif;
      background: #f5f5f5;
      min-height: 100vh;
      padding: 20px;
    }
    .container {
      max-width: 700px;
      margin: 0 auto;
    }
    .header {
      text-align: center;
      margin-bottom: 32px;
    }
    h1 { color: #1e3a5f; margin-bottom: 8px; font-size: 1.75rem; }
    .subtitle { color: #666; font-size: 0.9rem; }
    .card {
      background: white;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      margin-bottom: 24px;
    }
    .error-card {
      border: 2px solid #ef4444;
      text-align: center;
      max-width: 400px;
      margin: 100px auto;
    }
    .section-title {
      color: #1e3a5f;
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 16px;
      padding-bottom: 8px;
      border-bottom: 2px solid #e5e7eb;
    }
    .feature-list {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .feature-item {
      background: #f9fafb;
      border-radius: 8px;
      padding: 16px;
    }
    .feature-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 8px;
    }
    .feature-name {
      font-weight: 600;
      color: #1e3a5f;
    }
    .feature-id {
      font-size: 0.75rem;
      color: #9ca3af;
      font-family: monospace;
    }
    .feature-description {
      color: #6b7280;
      font-size: 0.9rem;
      margin-bottom: 12px;
    }
    .status-toggle {
      display: flex;
      gap: 8px;
    }
    .status-btn {
      padding: 6px 14px;
      border: 2px solid #e5e7eb;
      border-radius: 6px;
      background: white;
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    .status-btn:hover {
      border-color: #9ca3af;
    }
    .status-btn.active {
      font-weight: 600;
    }
    .status-btn[data-status="off"].active {
      background: #fef2f2;
      border-color: #ef4444;
      color: #ef4444;
    }
    .status-btn[data-status="beta"].active {
      background: #fffbeb;
      border-color: #f59e0b;
      color: #f59e0b;
    }
    .status-btn[data-status="on"].active {
      background: #f0fdf4;
      border-color: #22c55e;
      color: #22c55e;
    }
    .save-section {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 24px;
      padding-top: 16px;
      border-top: 1px solid #e5e7eb;
    }
    .save-btn {
      background: #1e3a5f;
      color: white;
      border: none;
      padding: 10px 24px;
      border-radius: 8px;
      font-size: 0.95rem;
      cursor: pointer;
      transition: background 0.2s;
    }
    .save-btn:hover {
      background: #2d5a87;
    }
    .save-btn:disabled {
      background: #9ca3af;
      cursor: not-allowed;
    }
    .save-status {
      font-size: 0.85rem;
      color: #6b7280;
    }
    .save-status.success {
      color: #22c55e;
    }
    .save-status.error {
      color: #ef4444;
    }
    .beta-section {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      color: white;
    }
    .beta-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 16px;
    }
    .beta-info h3 {
      font-size: 1rem;
      margin-bottom: 4px;
    }
    .beta-info p {
      font-size: 0.85rem;
      opacity: 0.9;
    }
    .beta-url {
      background: rgba(255,255,255,0.2);
      padding: 8px 16px;
      border-radius: 6px;
      font-family: monospace;
      font-size: 0.85rem;
      cursor: pointer;
      transition: background 0.2s;
    }
    .beta-url:hover {
      background: rgba(255,255,255,0.3);
    }
    .empty-state {
      text-align: center;
      padding: 40px;
      color: #6b7280;
    }
    .empty-state p {
      margin-bottom: 16px;
    }
    .empty-state code {
      background: #f3f4f6;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 0.85rem;
    }
    .refresh {
      text-align: center;
      color: #666;
      font-size: 0.85rem;
      margin-top: 16px;
    }
    .refresh a {
      color: #1e3a5f;
      text-decoration: underline;
    }
    .error { color: #ef4444; }
    .not-configured {
      color: #f59e0b;
      font-size: 0.9rem;
      text-align: center;
      padding: 40px;
    }
  </style>
</head>
<body>
  {!hasAccess ? (
    <div class="card error-card">
      <h1 class="error">Ingen tilgang</h1>
      <p>Ugyldig eller manglende token.</p>
    </div>
  ) : (
    <div class="container">
      <div class="header">
        <h1>Feature Toggles</h1>
        <p class="subtitle">Styr hvilke features som er synlige</p>
      </div>

      {betaActivationUrl && (
        <div class="card beta-section">
          <div class="beta-content">
            <div class="beta-info">
              <h3>Beta-aktivering</h3>
              <p>Del denne lenken med testbrukere</p>
            </div>
            <div class="beta-url" id="beta-url" title="Klikk for å kopiere">
              {Astro.url.origin}{betaActivationUrl}
            </div>
          </div>
        </div>
      )}

      <div class="card">
        <h2 class="section-title">Features</h2>

        {features.length === 0 ? (
          <div class="empty-state">
            <p>Ingen features er definert ennå.</p>
            <p>Legg til features i <code>src/utils/feature-toggles.ts</code></p>
          </div>
        ) : (
          <div class="feature-list" id="feature-list">
            {features.map((feature) => (
              <div class="feature-item" data-feature-id={feature.id}>
                <div class="feature-header">
                  <div>
                    <div class="feature-name">{feature.name}</div>
                    <div class="feature-id">{feature.id}</div>
                  </div>
                </div>
                <div class="feature-description">{feature.description}</div>
                <div class="status-toggle">
                  <button
                    class={`status-btn ${feature.status === 'off' ? 'active' : ''}`}
                    data-status="off"
                  >
                    Av
                  </button>
                  <button
                    class={`status-btn ${feature.status === 'beta' ? 'active' : ''}`}
                    data-status="beta"
                  >
                    Beta
                  </button>
                  <button
                    class={`status-btn ${feature.status === 'on' ? 'active' : ''}`}
                    data-status="on"
                  >
                    På
                  </button>
                </div>
              </div>
            ))}
          </div>
        )}

        {features.length > 0 && (
          <div class="save-section">
            <span class="save-status" id="save-status"></span>
            <button class="save-btn" id="save-btn">Lagre endringer</button>
          </div>
        )}
      </div>

      {updatedAt && (
        <p class="refresh">
          <a href={`/feature-toggles?token=${providedToken}`}>Oppdater</a> · Sist endret: {new Date(updatedAt).toLocaleString('no-NO')}
        </p>
      )}
    </div>
  )}

  <script define:vars={{ providedToken }}>
    // Copy beta URL to clipboard
    const betaUrlEl = document.getElementById('beta-url');
    if (betaUrlEl) {
      betaUrlEl.addEventListener('click', () => {
        navigator.clipboard.writeText(betaUrlEl.textContent.trim());
        const original = betaUrlEl.textContent;
        betaUrlEl.textContent = 'Kopiert!';
        setTimeout(() => {
          betaUrlEl.textContent = original;
        }, 2000);
      });
    }

    // Handle status toggle
    document.querySelectorAll('.status-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const button = e.target;
        const featureItem = button.closest('.feature-item');
        const statusToggle = featureItem.querySelector('.status-toggle');

        // Remove active from all buttons in this toggle
        statusToggle.querySelectorAll('.status-btn').forEach(b => b.classList.remove('active'));

        // Add active to clicked button
        button.classList.add('active');

        // Clear save status
        document.getElementById('save-status').textContent = '';
        document.getElementById('save-status').className = 'save-status';
      });
    });

    // Handle save
    const saveBtn = document.getElementById('save-btn');
    const saveStatus = document.getElementById('save-status');

    if (saveBtn) {
      saveBtn.addEventListener('click', async () => {
        saveBtn.disabled = true;
        saveStatus.textContent = 'Lagrer...';
        saveStatus.className = 'save-status';

        // Collect all feature states
        const features = [];
        document.querySelectorAll('.feature-item').forEach(item => {
          const id = item.dataset.featureId;
          const name = item.querySelector('.feature-name').textContent;
          const description = item.querySelector('.feature-description').textContent;
          const activeBtn = item.querySelector('.status-btn.active');
          const status = activeBtn ? activeBtn.dataset.status : 'off';

          features.push({ id, name, description, status });
        });

        try {
          const response = await fetch('/api/feature-toggles', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ token: providedToken, features }),
          });

          if (response.ok) {
            saveStatus.textContent = 'Lagret!';
            saveStatus.className = 'save-status success';
          } else {
            const data = await response.json();
            saveStatus.textContent = data.error || 'Feil ved lagring';
            saveStatus.className = 'save-status error';
          }
        } catch (error) {
          saveStatus.textContent = 'Nettverksfeil';
          saveStatus.className = 'save-status error';
        }

        saveBtn.disabled = false;
      });
    }
  </script>
</body>
</html>
