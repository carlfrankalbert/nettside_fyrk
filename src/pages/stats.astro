---
export const prerender = false;

import { TRACKED_BUTTONS } from './api/track';
import { TRACKED_PAGES } from './api/pageview';
import { AnalyticsDashboard } from '../components/dashboard';
import '@fontsource/inter/400.css';
import '@fontsource/inter/500.css';
import '@fontsource/inter/600.css';
import '@fontsource/inter/700.css';

// Get the secret token from environment
const cloudflareEnv = Astro.locals.runtime?.env;
const expectedToken = cloudflareEnv?.STATS_TOKEN;

// Check token from URL
const url = new URL(Astro.request.url);
const providedToken = url.searchParams.get('token');

// Validate access with specific error reasons
const tokenNotConfigured = !expectedToken;
const tokenMismatch = expectedToken && providedToken !== expectedToken;
const hasAccess = expectedToken && providedToken === expectedToken;

// Get all click counts if authorized
type ButtonCounts = Record<string, { count: number; label: string }>;
type PageStats = Record<string, { label: string; totalViews: number; totalVisitors: number; todayVisitors: number }>;

let buttonCounts: ButtonCounts | null = null;
let pageStats: PageStats | null = null;
let totalClicks = 0;

if (hasAccess) {
  const kv = cloudflareEnv?.ANALYTICS_KV;
  if (kv) {
    // Get button click counts
    buttonCounts = {};
    for (const [id, config] of Object.entries(TRACKED_BUTTONS)) {
      const currentCount = await kv.get(config.key);
      const count = parseInt(currentCount || '0', 10) || 0;
      buttonCounts[id] = {
        count,
        label: config.label,
      };
      totalClicks += count;
    }

    // Get page view stats
    pageStats = {};
    const today = new Date().toISOString().split('T')[0];
    for (const [id, config] of Object.entries(TRACKED_PAGES)) {
      const totalViewsKey = config.key;
      const totalVisitorsKey = `visitors_total:${id}`;
      const todayVisitorsKey = `visitors:${id}:${today}`;

      const totalViews = await kv.get(totalViewsKey);
      const totalVisitors = await kv.get(totalVisitorsKey);
      const todayVisitorsJson = await kv.get(todayVisitorsKey);

      let todayVisitors = 0;
      try {
        const visitors = todayVisitorsJson ? JSON.parse(todayVisitorsJson) : [];
        todayVisitors = visitors.length;
      } catch {
        todayVisitors = 0;
      }

      pageStats[id] = {
        label: config.label,
        totalViews: parseInt(totalViews || '0', 10) || 0,
        totalVisitors: parseInt(totalVisitors || '0', 10) || 0,
        todayVisitors,
      };
    }
  }
}
---

<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex, nofollow">
  <link rel="icon" type="image/svg+xml" href="/fyrk-monogram-primary-navy.svg" />
  <title>Analytics - FYRK</title>
  <style is:global>
    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    html {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
  </style>
</head>
<body>
  {tokenNotConfigured ? (
    <div class="min-h-screen bg-slate-50 flex items-center justify-center p-4">
      <div class="bg-white border border-amber-200 rounded-2xl p-8 text-center max-w-md shadow-lg">
        <div class="w-16 h-16 bg-amber-100 rounded-full flex items-center justify-center mx-auto mb-4">
          <svg class="w-8 h-8 text-amber-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
          </svg>
        </div>
        <h1 class="text-xl font-bold text-slate-900 mb-2">STATS_TOKEN ikke konfigurert</h1>
        <p class="text-slate-500">Legg til STATS_TOKEN i Cloudflare Pages milj√∏variabler.</p>
      </div>
    </div>
  ) : tokenMismatch ? (
    <div class="min-h-screen bg-slate-50 flex items-center justify-center p-4">
      <div class="bg-white border border-red-200 rounded-2xl p-8 text-center max-w-md shadow-lg">
        <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
          <svg class="w-8 h-8 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
          </svg>
        </div>
        <h1 class="text-xl font-bold text-slate-900 mb-2">Feil token</h1>
        <p class="text-slate-500">Token i URL matcher ikke STATS_TOKEN.</p>
      </div>
    </div>
  ) : buttonCounts !== null && pageStats !== null ? (
    <AnalyticsDashboard
      client:load
      buttonCounts={buttonCounts}
      pageStats={pageStats}
      totalClicks={totalClicks}
      refreshToken={providedToken || ''}
    />
  ) : (
    <div class="min-h-screen bg-slate-50 flex items-center justify-center p-4">
      <div class="bg-white border border-amber-200 rounded-2xl p-8 text-center max-w-md shadow-lg">
        <div class="w-16 h-16 bg-amber-100 rounded-full flex items-center justify-center mx-auto mb-4">
          <svg class="w-8 h-8 text-amber-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
          </svg>
        </div>
        <h1 class="text-xl font-bold text-slate-900 mb-2">KV ikke konfigurert</h1>
        <p class="text-slate-500">Analytics storage er ikke satt opp.</p>
      </div>
    </div>
  )}
</body>
</html>
