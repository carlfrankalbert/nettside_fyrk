---
export const prerender = false;

import { TRACKED_BUTTONS } from './api/track';
import { TRACKED_PAGES } from './api/pageview';
import { AnalyticsDashboard } from '../components/dashboard';
import '@fontsource/inter/400.css';
import '@fontsource/inter/500.css';
import '@fontsource/inter/600.css';
import '@fontsource/inter/700.css';

// Get the secret token from environment
const cloudflareEnv = Astro.locals.runtime?.env;
const expectedToken = cloudflareEnv?.STATS_TOKEN;

// Check token and period from URL
const url = new URL(Astro.request.url);
const providedToken = url.searchParams.get('token');

const validPeriods = ['today', '7d', '30d', 'all'] as const;
type Period = typeof validPeriods[number];
const rawPeriod = url.searchParams.get('period');
const period: Period = rawPeriod && (validPeriods as readonly string[]).includes(rawPeriod)
  ? rawPeriod as Period
  : 'today';

// Validate access with specific error reasons
const tokenNotConfigured = !expectedToken;
const tokenMismatch = expectedToken && providedToken !== expectedToken;
const hasAccess = expectedToken && providedToken === expectedToken;

// Data types
type ButtonCounts = Record<string, { count: number; label: string }>;
type PageStats = Record<string, { label: string; views: number; visitors: number }>;
type ToolMetrics = {
  count: number;
  totalCharCount: number;
  totalProcessingTimeMs: number;
  cachedCount: number;
  freshCount: number;
  errorTypes: Record<string, number>;
  uniqueSessionCount: number;
  hourlyDistribution: Record<string, number>;
};
type AllMetrics = Record<string, ToolMetrics>;

let buttonCounts: ButtonCounts | null = null;
let pageStats: PageStats | null = null;
let toolMetrics: AllMetrics | null = null;
let totalClicks = 0;
let dataTimestamp: number | null = null;

/**
 * Get YYYY-MM-DD date strings for a period (most recent first)
 */
function getDateRange(p: Period): string[] {
  const days = p === 'today' ? 1 : p === '7d' ? 7 : p === '30d' ? 30 : 0;
  const dates: string[] = [];
  for (let i = 0; i < days; i++) {
    const date = new Date();
    date.setDate(date.getDate() - i);
    dates.push(date.toISOString().split('T')[0]);
  }
  return dates;
}

if (hasAccess) {
  dataTimestamp = Date.now();
  const kv = cloudflareEnv?.ANALYTICS_KV;
  if (kv) {
    const buttonEntries = Object.entries(TRACKED_BUTTONS) as [string, { key: string; label: string }][];
    const pageEntries = Object.entries(TRACKED_PAGES);
    const metricsEvents = ['check_success', 'konseptspeil_success', 'antakelseskart_success', 'premortem_success'];
    const errorEvents = ['okr_error', 'konseptspeil_error', 'antakelseskart_error', 'premortem_error'];
    const allEvents = [...metricsEvents, ...errorEvents];

    if (period === 'all') {
      // --- All-time: use existing total counters ---

      // Button counts from total keys
      buttonCounts = {};
      const buttonResults = await Promise.all(buttonEntries.map(([, config]) => kv.get(config.key)));
      buttonEntries.forEach(([id, config], i) => {
        const count = parseInt(buttonResults[i] || '0', 10) || 0;
        buttonCounts![id] = { count, label: config.label };
        totalClicks += count;
      });

      // Page stats from total keys
      pageStats = {};
      const [viewResults, visitorResults] = await Promise.all([
        Promise.all(pageEntries.map(([, config]) => kv.get(config.key))),
        Promise.all(pageEntries.map(([id]) => kv.get(`visitors_total:${id}`))),
      ]);
      pageEntries.forEach(([id, config], i) => {
        pageStats![id] = {
          label: config.label,
          views: parseInt(viewResults[i] || '0', 10) || 0,
          visitors: parseInt(visitorResults[i] || '0', 10) || 0,
        };
      });

      // No meaningful metrics aggregation for all-time
      toolMetrics = {};

    } else {
      // --- Daily aggregation for today/7d/30d ---
      const dates = getDateRange(period);

      // Button counts: clicks_daily:{buttonId}:{date}
      buttonCounts = {};
      const dailyButtonKeys: { id: string; key: string }[] = [];
      for (const [id] of buttonEntries) {
        for (const date of dates) {
          dailyButtonKeys.push({ id, key: `clicks_daily:${id}:${date}` });
        }
      }
      const dailyButtonResults = await Promise.all(dailyButtonKeys.map(k => kv.get(k.key)));
      for (let i = 0; i < dailyButtonKeys.length; i++) {
        const { id } = dailyButtonKeys[i];
        if (!buttonCounts[id]) {
          const entry = buttonEntries.find(([eid]) => eid === id);
          buttonCounts[id] = { count: 0, label: entry?.[1].label || id };
        }
        buttonCounts[id].count += parseInt(dailyButtonResults[i] || '0', 10) || 0;
      }
      totalClicks = Object.values(buttonCounts).reduce((sum, b) => sum + b.count, 0);

      // Page stats: pageviews_daily + visitors arrays
      pageStats = {};
      const allPageViewKeys: string[] = [];
      const allVisitorKeys: string[] = [];
      for (const [id] of pageEntries) {
        for (const date of dates) {
          allPageViewKeys.push(`pageviews_daily:${id}:${date}`);
          allVisitorKeys.push(`visitors:${id}:${date}`);
        }
      }
      const [pageViewResults, visitorJsonResults] = await Promise.all([
        Promise.all(allPageViewKeys.map(key => kv.get(key))),
        Promise.all(allVisitorKeys.map(key => kv.get(key))),
      ]);
      let idx = 0;
      for (const [id, config] of pageEntries) {
        let views = 0;
        const uniqueHashes = new Set<string>();
        for (let d = 0; d < dates.length; d++) {
          views += parseInt(pageViewResults[idx] || '0', 10) || 0;
          try {
            const visitors: string[] = visitorJsonResults[idx] ? JSON.parse(visitorJsonResults[idx]!) : [];
            visitors.forEach(v => uniqueHashes.add(v));
          } catch { /* skip invalid JSON */ }
          idx++;
        }
        pageStats[id] = { label: config.label, views, visitors: uniqueHashes.size };
      }

      // Tool metrics: metrics:{eventId}:{date}
      toolMetrics = {};
      const metricsKeys: { eventId: string; key: string }[] = [];
      for (const eventId of allEvents) {
        for (const date of dates) {
          metricsKeys.push({ eventId, key: `metrics:${eventId}:${date}` });
        }
      }
      const metricsResults = await Promise.all(metricsKeys.map(k => kv.get(k.key)));
      for (let i = 0; i < metricsKeys.length; i++) {
        const { eventId } = metricsKeys[i];
        const json = metricsResults[i];
        if (!json) continue;
        try {
          const parsed = JSON.parse(json);
          if (!toolMetrics[eventId]) {
            toolMetrics[eventId] = {
              count: 0,
              totalCharCount: 0,
              totalProcessingTimeMs: 0,
              cachedCount: 0,
              freshCount: 0,
              errorTypes: {},
              uniqueSessionCount: 0,
              hourlyDistribution: {},
            };
          }
          const m = toolMetrics[eventId];
          m.count += parsed.count || 0;
          m.totalCharCount += parsed.totalCharCount || 0;
          m.totalProcessingTimeMs += parsed.totalProcessingTimeMs || 0;
          m.cachedCount += parsed.cachedCount || 0;
          m.freshCount += parsed.freshCount || 0;
          for (const [type, count] of Object.entries(parsed.errorTypes || {})) {
            m.errorTypes[type] = (m.errorTypes[type] || 0) + (count as number);
          }
          for (const [hour, count] of Object.entries(parsed.hourlyDistribution || {})) {
            m.hourlyDistribution[hour] = (m.hourlyDistribution[hour] || 0) + (count as number);
          }
          m.uniqueSessionCount += parsed.uniqueSessionCount || (parsed.uniqueSessions?.length || 0);
        } catch {
          // Skip invalid metrics
        }
      }
    }
  }
}
---

<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex, nofollow">
  <link rel="icon" type="image/svg+xml" href="/fyrk-monogram-primary-navy.svg" />
  <title>Analytics - FYRK</title>
  <style is:global>
    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    html {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
  </style>
</head>
<body>
  {tokenNotConfigured ? (
    <div class="min-h-screen bg-slate-50 flex items-center justify-center p-4">
      <div class="bg-white border border-amber-200 rounded-2xl p-8 text-center max-w-md shadow-lg">
        <div class="w-16 h-16 bg-amber-100 rounded-full flex items-center justify-center mx-auto mb-4">
          <svg class="w-8 h-8 text-amber-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
          </svg>
        </div>
        <h1 class="text-xl font-bold text-slate-900 mb-2">STATS_TOKEN ikke konfigurert</h1>
        <p class="text-slate-500">Legg til STATS_TOKEN i Cloudflare Pages milj&oslash;variabler.</p>
      </div>
    </div>
  ) : tokenMismatch ? (
    <div class="min-h-screen bg-slate-50 flex items-center justify-center p-4">
      <div class="bg-white border border-red-200 rounded-2xl p-8 text-center max-w-md shadow-lg">
        <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
          <svg class="w-8 h-8 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
          </svg>
        </div>
        <h1 class="text-xl font-bold text-slate-900 mb-2">Feil token</h1>
        <p class="text-slate-500">Token i URL matcher ikke STATS_TOKEN.</p>
      </div>
    </div>
  ) : buttonCounts !== null && pageStats !== null ? (
    <AnalyticsDashboard
      client:load
      period={period}
      buttonCounts={buttonCounts}
      pageStats={pageStats}
      totalClicks={totalClicks}
      refreshToken={providedToken || ''}
      toolMetrics={toolMetrics || {}}
      dataTimestamp={dataTimestamp || Date.now()}
    />
  ) : (
    <div class="min-h-screen bg-slate-50 flex items-center justify-center p-4">
      <div class="bg-white border border-amber-200 rounded-2xl p-8 text-center max-w-md shadow-lg">
        <div class="w-16 h-16 bg-amber-100 rounded-full flex items-center justify-center mx-auto mb-4">
          <svg class="w-8 h-8 text-amber-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
          </svg>
        </div>
        <h1 class="text-xl font-bold text-slate-900 mb-2">KV ikke konfigurert</h1>
        <p class="text-slate-500">Analytics storage er ikke satt opp.</p>
      </div>
    </div>
  )}
</body>
</html>
