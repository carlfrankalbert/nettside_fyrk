---
import PublicLayout from '../../layouts/PublicLayout.astro';
import { createServiceRoleClient } from '../../lib/supabase';

const { token } = Astro.params;

if (!token) {
  return Astro.redirect('/login');
}

const supabase = createServiceRoleClient();

const { data: lock } = await supabase
  .from('decision_locks')
  .select('*')
  .eq('share_token', token)
  .single();

if (!lock) {
  return Astro.redirect('/404');
}

const { data: entry } = await supabase
  .from('day_entries')
  .select('date, one_thing')
  .eq('id', lock.day_entry_id)
  .single();

if (!entry) {
  return Astro.redirect('/404');
}

const pageTitle = `Decision: ${entry.one_thing} â€” Decision Loop`;
const description = lock.decision_text.length > 160
  ? lock.decision_text.slice(0, 157) + '...'
  : lock.decision_text;
const pageUrl = Astro.url.href;
---

<PublicLayout title={pageTitle}>
  <Fragment slot="head">
    <meta property="og:title" content={pageTitle} />
    <meta property="og:description" content={description} />
    <meta property="og:type" content="article" />
    <meta property="og:url" content={pageUrl} />
    <meta name="description" content={description} />
  </Fragment>

  <div class="pt-8">
    <p class="text-sm text-neutral-500">{entry.date}</p>
    <h1 class="mt-1 text-2xl font-bold">{entry.one_thing}</h1>

    <div class="mt-6 space-y-4">
      <div>
        <h2 class="text-sm font-semibold text-neutral-600">Decision</h2>
        <p class="mt-1">{lock.decision_text}</p>
      </div>

      {lock.assumptions && (
        <div>
          <h2 class="text-sm font-semibold text-neutral-600">Assumptions</h2>
          <p class="mt-1">{lock.assumptions}</p>
        </div>
      )}

      {lock.practical_change && (
        <div>
          <h2 class="text-sm font-semibold text-neutral-600">Practical change</h2>
          <p class="mt-1">{lock.practical_change}</p>
        </div>
      )}
    </div>

    <hr class="my-8 border-neutral-200" />
    <p class="text-sm text-neutral-500">
      This decision was shared for review. <a href="https://fyrk.no" class="underline">fyrk.no</a>
    </p>
  </div>
</PublicLayout>
